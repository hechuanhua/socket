<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>聊天界面</title>
        <meta content="width=device-width,user-scalable=no,minimum-scale=1.0,maximum-scale=1.0,initial-scale=1.0" name="viewport">
    </head>
    <style type="text/css">
* { box-sizing: border-box; margin: 0; padding: 0; }
img { max-width: 100%; }
.img { float: left; height: 40px; margin: 15px auto auto; overflow: hidden; text-align: center; width: 40px; }
.img img { border-radius: 50%; height: 40px; vertical-align: middle; width: 40px; }
.info { display: inline-block; max-width: 60%; }
.chatItem_r .infoWrap { text-align: right; }
.chatItem_l { overflow: hidden; padding: 13px 27px 13px 10px; }
.chat { background: none repeat scroll 0 0 #ade7ee; line-height: 1.5; word-break: break-all;}
.box{overflow-y: scroll;height: 100%;margin-left: 150px;}
.infoBox { background: none repeat scroll 0 0 white; border-radius: 8px; margin-top: 3px; padding: 10px; position: relative; text-align: left; }
.infoTop { font-size: 12px; overflow: hidden; padding: 0 10px; }
.name { color: #666; float: left; }
.time { color: #999; float: right; }
.chatItem_l .infoBox::before { background: none repeat scroll 0 0 white; content: ""; height: 10px; left: -5px; position: absolute; top: 9px; transform: rotate(45deg); -webkit-transform: rotate(45deg); width: 10px; }
.infoWrap { padding-left: 60px; }
.chatItem_r { padding: 13px 10px 13px 27px; }
.chatItem_r .img { float: right; }
.chatItem_r .infoWrap { padding-right: 60px; padding-left: 0; }
.chatItem_r .infoBox::before { right: -5px; background: none repeat scroll 0 0 white; content: ""; height: 10px; position: absolute; top: 9px; transform: rotate(45deg); -webkit-transform: rotate(45deg); width: 10px; }
.inputBox { height: 40px; line-height: 40px; position: fixed; bottom: 10px; width: 100%; display: flex; }
.inputBox input[type="text"] { height: 100%; flex: 1; outline: none; }
.inputBox input[type="button"] { width: 80px; margin-left: 5px; cursor: pointer; }
.sideBox { position: absolute; top: 0; background: #fff; border-right: 1px solid #ccc; width: 150px; bottom: 50px;}
.onLine { text-align: center; height: 30px; line-height: 30px; cursor: pointer; background: #eee; }
.setName { position: fixed; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); color: #fff; }
.setName p { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; text-align: center; }
.setName input[type="text"] { height: 35px; line-height: 35px; border: 1px solid #ccc;padding: 0 5px;font-size: 14px; }
.setName input[type="button"] { height: 35px; line-height: 35px; border: 1px solid #ccc;width: 40px;cursor: pointer; }
.welcome { text-align: center; background: #e2e2e2; }
    </style>
    <body>
    <div class="chat" id="chatBox">
        <div class="box" id="box">
            
        </div>
        <div class="sideBox">
            <div class="onLine">当前<span id="num">0</span>人在线</div>
        </div>
    </div>
    <div class="inputBox">
        <input type="text" id="text">
        <input type="button" value="发布" id="send">
    </div>
    <div class="setName" id="setName">
        <p>设置名字：<input type="text" id="nickName"> <input type="button" value="确定" id="enterName"></p>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
    var selfTmp=`<div class="chatItem_r">
                <div class="img"><img src="http://shp.qpic.cn/bizmp/m811bgI6arw7uUicRJJuiaibB9No0f8oOcWqBwseEibvlqIoWGwGzmoStQ/132" alt="" /></div>
                <div class="infoWrap">
                    <div class="info">
                        <div class="infoTop">
                                <div class="name">{{name}}</div>
                                <div class="time">{{time}}</div>
                        </div>
                        <div class="infoBox">
                            <div class="infoMain">{{text}}</div>
                        </div>
                    </div>
                </div>  
            </div>`
    var otherTmp=`<div class="chatItem_l">
                <div class="img"><img src="http://shp.qpic.cn/bizmp/m811bgI6arw7uUicRJJuiaibB9No0f8oOcWqBwseEibvlqIoWGwGzmoStQ/132" alt="" /></div>
                <div class="infoWrap">
                    <div class="info">
                        <div class="infoTop">
                                <div class="name">{{name}}</div>
                                <div class="time">{{time}}</div>
                        </div>
                        <div class="infoBox">
                            <div class="infoMain">{{text}}</div>
                        </div>
                    </div>
                </div>  
            </div>`
    var socket = io(),nickName;
    var $=function(element){
        return document.querySelector(element)
    }
    function Chat(){
        this.box=$('#box')
        this.init()
    }
    Chat.prototype.init=function(){
        var _this=this
        $('#chatBox').style.cssText='height:'+(document.documentElement.clientHeight-50)+'px'
        $('#enterName').addEventListener('click',function(){
            nickName=$('#nickName').value.trim()
            console.log(nickName)
            socket.emit('login',nickName)
            $('#setName').remove()
        })
        socket.on("welcome",function(name){
            console.log("welcome",name,this)
            _this.box.insertAdjacentHTML("beforeEnd",'<div class="welcome">欢迎'+name+'进入聊天室</div>')
            _this.box.scrollTop=99999999
        })
        socket.on("loginSuccess",function(num){
            console.log("loginSuccess",num)
            $('#num').innerHTML=num
        })
        socket.on('loginOut', function (num) {
            console.log("loginOut",num)
            num=num
            $('#num').innerHTML=num
        })
    }
    new Chat()
    $('#send').addEventListener('click',function(){
        var date=new Date(),
        
        $('#box').insertAdjacentHTML("beforeEnd",selfTmp.replace(/{{text}}/ig,$('#text').value).replace(/{{name}}/,nickName));
        socket.emit('send', $('#text').value);
        $('#box').scrollTop=99999999
        $('#text').value='';
    });
    socket.on('send1', function (msg) {
        $('#box').insertAdjacentHTML("beforeEnd",otherTmp.replace(/{{text}}/ig,msg).replace(/{{name}}/,nickName));
        $('#box').scrollTop=99999999
    })   
     
    </script>
</body>
</html>