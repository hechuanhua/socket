<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>聊天界面</title>
        <meta content="width=device-width,user-scalable=no,minimum-scale=1.0,maximum-scale=1.0,initial-scale=1.0" name="viewport">
    </head>
    <style type="text/css">
* { box-sizing: border-box; margin: 0; padding: 0; }
img { max-width: 100%; }
input{outline: none;}
.img { float: left; height: 40px; margin: 15px auto auto; overflow: hidden; text-align: center; width: 40px; }
.img img { border-radius: 50%; height: 40px; vertical-align: middle; width: 40px; }
.info { display: inline-block; max-width: 60%; }
.chatItem_r .infoWrap { text-align: right; }
.chatItem_l { overflow: hidden; padding: 13px 27px 13px 10px; }
.chat { background: none repeat scroll 0 0 #ade7ee; line-height: 1.5; word-break: break-all;}
.box{overflow-y: scroll;height: 100%;margin-right: 100px;}
.infoBox { background: none repeat scroll 0 0 white; border-radius: 8px; margin-top: 3px; padding: 10px; position: relative; text-align: left; }
.infoTop { font-size: 12px; overflow: hidden; padding: 0 10px; }
.infoTop .name { color: #666; float: left; }
.infoTop .time { color: #999; float: right; }
.chatItem_l .infoBox::before { background: none repeat scroll 0 0 white; content: ""; height: 10px; left: -5px; position: absolute; top: 9px; transform: rotate(45deg); -webkit-transform: rotate(45deg); width: 10px; }
.infoWrap { padding-left: 60px; }
.chatItem_r { padding: 13px 10px 13px 27px; }
.chatItem_r .img { float: right; }
.chatItem_r .infoWrap { padding-right: 60px; padding-left: 0; }
.chatItem_r .infoBox::before { right: -5px; background: none repeat scroll 0 0 white; content: ""; height: 10px; position: absolute; top: 9px; transform: rotate(45deg); -webkit-transform: rotate(45deg); width: 10px; }
.inputBox { height: 40px; line-height: 40px; position: fixed; bottom: 10px; width: 100%; display: flex; }
.inputBox input[type="text"] { height: 100%; flex: 1; outline: none; }
.inputBox input[type="button"] { width: 80px; margin-left: 5px; cursor: pointer; }
.sideBox { position: absolute; top: 0; background: #fff; border-right: 1px solid #ccc; width: 150px; bottom: 50px;}
.setName { position: fixed; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); color: #fff; }
.setName p { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;display: flex;align-items:center; }
.setName input[type="text"] { height: 35px; line-height: 35px; border: 1px solid #ccc;padding: 0 5px;font-size: 14px; }
.setName input[type="button"] { height: 35px; line-height: 35px; border: 1px solid #ccc;width: 40px;cursor: pointer;margin-left: 20px; }
.welcome { text-align: center; background: #e2e2e2; }
.onLine { text-align: center; height: 30px; line-height: 30px; cursor: pointer;}
.onLineList { position: absolute; right: 0; width: 100px; height: 100%; top: 0; }
.onLine-item { display: flex; align-items: center; font-size: 15px; cursor: pointer; height: 24px; overflow: hidden;user-select:none; }
.onLine-item img { width: 20px; height: 20px; border-radius: 50%; margin-right: 5px; }
.onLine-item .name { overflow: hidden; display: inline-block; text-overflow: ellipsis; white-space: nowrap; }
.onLine-item:hover{background: #f3edd7}
    </style>
    <body>
    <div class="chat" id="chatBox">
        <div class="box" id="box">
            
        </div>
        <div class="onLineList">
            <div class="onLine">当前<span id="num">0</span>人在线</div>
            <div class="onLine-item">
                <img src="http://shp.qpic.cn/bizmp/m811bgI6arw7uUicRJJuiaibB9No0f8oOcWqBwseEibvlqIoWGwGzmoStQ/132" alt="" />
                <span class="name">贺传华</span>
            </div>
            <div class="onLine-item">
                <img src="http://shp.qpic.cn/bizmp/m811bgI6arw7uUicRJJuiaibB9No0f8oOcWqBwseEibvlqIoWGwGzmoStQ/132" alt="" />
                <span class="name">贺传华</span>
            </div>
            <div class="onLine-item">
                <img src="http://shp.qpic.cn/bizmp/m811bgI6arw7uUicRJJuiaibB9No0f8oOcWqBwseEibvlqIoWGwGzmoStQ/132" alt="" />
                <span class="name">贺传华</span>
            </div>
        </div>
    </div>
    <div class="inputBox">
        <input type="text" id="text">
        <input type="button" value="发布" id="send">
    </div>
    <div class="setName" id="setName">
        <p>设置名字：<input type="text" id="nickName"> <input type="button" value="确定" id="enterName"></p>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
    var selfTmp=`<div class="chatItem_r">
                <div class="img"><img src="http://shp.qpic.cn/bizmp/m811bgI6arw7uUicRJJuiaibB9No0f8oOcWqBwseEibvlqIoWGwGzmoStQ/132" alt="" /></div>
                <div class="infoWrap">
                    <div class="info">
                        <div class="infoTop">
                                <div class="name">{{name}}</div>
                                <div class="time">{{time}}</div>
                        </div>
                        <div class="infoBox">
                            <div class="infoMain">{{text}}</div>
                        </div>
                    </div>
                </div>  
            </div>`
    var otherTmp=`<div class="chatItem_l">
                <div class="img"><img src="http://shp.qpic.cn/bizmp/m811bgI6arw7uUicRJJuiaibB9No0f8oOcWqBwseEibvlqIoWGwGzmoStQ/132" alt="" /></div>
                <div class="infoWrap">
                    <div class="info">
                        <div class="infoTop">
                                <div class="name">{{name}}</div>
                                <div class="time">{{time}}</div>
                        </div>
                        <div class="infoBox">
                            <div class="infoMain">{{text}}</div>
                        </div>
                    </div>
                </div>  
            </div>`
    var socket = io(),nickName;
    var $=function(element){
        return document.querySelector(element)
    }
    function Chat(){
        this.box=$('#box')
        this.init()
    }
    Chat.prototype.init=function(){
        var _this=this
        $('#chatBox').style.cssText='height:'+(document.documentElement.clientHeight-50)+'px'
        /*设置名称*/
        $('#enterName').addEventListener('click',function(){
            nickName=$('#nickName').value.trim()
            if(!nickName)return
            socket.emit('login',nickName)
            $('#setName').remove()
        })
        /*欢迎消息*/
        socket.on("welcome",function(name){
            console.log("welcome",name,this)
            _this.box.insertAdjacentHTML("beforeEnd",'<div class="welcome">欢迎'+name+'进入聊天室</div>')
            _this.box.scrollTop=99999999
        })
        /*有人登录进来*/
        socket.on("loginSuccess",function(num){
            console.log("loginSuccess",num)
            $('#num').innerHTML=num
        })
        /*有人退出了*/
        socket.on('loginOut', function (num,name) {
            console.log("loginOut",num)
            $('#num').innerHTML=num
            _this.box.insertAdjacentHTML("beforeEnd",'<div class="welcome">'+name+'已经退出了聊天室</div>')
        })
    }
    new Chat()
    /*发布聊天内容*/
    $('#send').addEventListener('click',function(){
        var date=new Date(),
        Month=date.getMonth()+1,
        Day=date.getDate(),
        Hours=date.getHours()>=10?date.getHours():"0"+date.getHours(),
        Minutes=date.getMinutes()>=10?date.getMinutes():"0"+date.getMinutes(),
        Seconds=date.getSeconds()>=10?date.getSeconds():"0"+date.getSeconds(),
        time=Month+"-"+Day+" "+Hours+":"+Minutes+":"+Seconds, 
        value=$('#text').value.trim()
        user={nickName:nickName,value:value,time:time,toNickName:2222}
        $('#box').insertAdjacentHTML("beforeEnd",selfTmp.replace(/{{text}}/,$('#text').value).replace(/{{name}}/,nickName).replace(/{{time}}/,time));
        socket.emit('send', user);
        $('#box').scrollTop=99999999
        $('#text').value='';
    });
    /*接受聊天内容*/
    socket.on('send1', function (user) {
        console.log(user.toNickName,nickName)
        if(user.toNickName==nickName){
            $('#box').insertAdjacentHTML("beforeEnd",otherTmp.replace(/{{text}}/,user.value).replace(/{{name}}/,user.nickName).replace(/{{time}}/,user.time));
            $('#box').scrollTop=99999999
        }
    })   
     
    </script>
</body>
</html>